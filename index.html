<script>
    // Global state
    let currentRoom = null;
    let participantId = null;
    let syllableFormat = '5-7-5';
    let artStyle = 'watercolor';
    const syllableCounts = {
        '5-7-5': [5, 7, 5],
        '3-5-3': [3, 5, 3]
    };
    
    // Art style descriptions
    const artStyleDescriptions = {
        'watercolor': 'Watercolor painting with gentle flowing colors',
        'children': 'Colorful children\'s book illustration, whimsical and friendly',
        'japanese': 'Traditional Japanese ukiyo-e woodblock print style',
        'cartoon': 'Vibrant cartoon with bold colors and simple shapes',
        'simpsons': 'The Simpsons cartoon style with yellow characters',
        'abstract': 'Abstract expressionist with flowing colors and shapes',
        'picasso': 'Pablo Picasso cubist style with geometric shapes',
        'realistic': 'Realistic photograph-like with natural lighting'
    };
    
    // API base URL
    const API_BASE = 'https://blind-haiku-api.averycolgin.workers.dev';

    // On load
    window.onload = function() {
        loadCreditsStatus();
        updateArtStylePreview();
        
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room');
        if (roomCode) {
            document.getElementById('room-code').value = roomCode.toUpperCase();
            showJoinForm();
        }

        document.getElementById('art-style').addEventListener('change', updateArtStylePreview);
        document.getElementById('room-code').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    };

    function updateArtStylePreview() {
        const style = document.getElementById('art-style').value;
        document.getElementById('art-style-preview').textContent = artStyleDescriptions[style];
    }

    // --- Credits ---
    function loadCreditsStatus() {
        fetch(`${API_BASE}/api/credits`)
        .then(r => r.json())
        .then(data => updateCreditsDisplay(data))
        .catch(err => {
            console.error('Error loading credits:', err);
            document.getElementById('credits-text').textContent = 'Credits: Unable to load';
        });
    }

    function updateCreditsDisplay(credits) {
        const creditsEl = document.getElementById('credits-display');
        const textEl = document.getElementById('credits-text');
        
        textEl.textContent = `Daily AI images: ${credits.used}/${credits.daily_limit} used (${credits.remaining} remaining)`;
        
        if (credits.remaining <= 0) {
            creditsEl.classList.add('credits-warning');
            textEl.textContent += ' - Limit reached for today';
        } else if (credits.remaining <= 5) {
            creditsEl.classList.add('credits-warning');
        } else {
            creditsEl.classList.remove('credits-warning');
        }
    }

    // --- Screens ---
    function showHome() {
        document.getElementById('home-screen').classList.remove('hidden');
        document.getElementById('join-screen').classList.add('hidden');
        document.getElementById('room-screen').classList.add('hidden');
    }

    function showJoinForm() {
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('join-screen').classList.remove('hidden');
        document.getElementById('room-screen').classList.add('hidden');
    }

    function showRoom() {
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('join-screen').classList.add('hidden');
        document.getElementById('room-screen').classList.remove('hidden');
    }

    // --- Room creation ---
    function createRoom() {
        syllableFormat = document.getElementById('syllable-format').value;
        artStyle = document.getElementById('art-style').value;

        fetch(`${API_BASE}/api/create-room`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                format: syllableFormat,
                artStyle: artStyle
            })
        })
        .then(r => r.json())
        .then(data => {
            if (!data || !data.roomCode) throw new Error("Invalid response from API");

            currentRoom = data.roomCode;
            participantId = data.participantId;

            // Fill in room details
            document.getElementById('current-room-code').textContent = currentRoom;
            document.getElementById('share-room-code').textContent = currentRoom;
            document.getElementById('current-format').textContent = syllableFormat;
            document.getElementById('current-art-style').textContent = artStyleDescriptions[artStyle];

            showRoom();
        })
        .catch(err => {
            console.error("Error creating room:", err);
            alert("Failed to create room. Please try again.");
        });
    }

    // --- Room join ---
    function joinRoom() {
        const roomCode = document.getElementById('room-code').value.trim().toUpperCase();
        if (!roomCode) return alert("Enter a room code");

        fetch(`${API_BASE}/api/join-room`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomCode })
        })
        .then(r => r.json())
        .then(data => {
            if (!data || !data.success) throw new Error("Join failed");

            currentRoom = roomCode;
            participantId = data.participantId;

            document.getElementById('current-room-code').textContent = currentRoom;
            document.getElementById('share-room-code').textContent = currentRoom;
            document.getElementById('current-format').textContent = data.format;
            document.getElementById('current-art-style').textContent = artStyleDescriptions[data.artStyle];

            showRoom();
        })
        .catch(err => {
            console.error("Error joining room:", err);
            alert("Failed to join room. Please check the code.");
        });
    }
</script>
